---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import MapView from "@components/MapView";

// Get the token the same way as in astro.config.ts
const MAPBOX_ACCESS_TOKEN = process.env.PUBLIC_MAPBOX_TOKEN;

const posts = await getCollection("blog", ({ data }) => !data.draft);
const geotaggedPosts = posts
  .filter(post => post.data.coordinates)
  .map(post => ({
    type: "Feature",
    geometry: {
      type: "Point",
      coordinates: [post.data.coordinates[1], post.data.coordinates[0]], // [lng, lat]
    },
    properties: {
      title: post.data.title,
      slug: post.slug,
      description: post.data.description,
    },
  }));

const geojson = {
  type: "FeatureCollection",
  features: geotaggedPosts,
};

console.log(
  "Server-side token check:",
  MAPBOX_ACCESS_TOKEN ? "Token exists" : "No token"
);
---

<script>
  // Log client-side environment variables
  console.log("Client-side env check:", {
    hasToken: !!import.meta.env.PUBLIC_MAPBOX_TOKEN,
    envKeys: Object.keys(import.meta.env),
  });
</script>

<Layout title="Post Map">
  <Header activeNav="map" />
  <main>
    <h1 class="text-2xl font-semibold mb-6">Posts Around the World</h1>
    <div class="w-full h-[600px] rounded-lg overflow-hidden shadow-lg">
      <MapView
        client:load
        geojson={geojson}
        mapboxToken={MAPBOX_ACCESS_TOKEN}
      />
    </div>
  </main>
  <Footer />
</Layout>

<style>
  main {
    @apply mx-auto w-full max-w-3xl px-4 pb-12;
  }
</style>
