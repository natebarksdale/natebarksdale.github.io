---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import MapView from "@components/MapView";

// Get posts data
const posts = await getCollection("blog", ({ data }) => !data.draft);
const geotaggedPosts = posts
  .filter(post => post.data.coordinates)
  .map(post => ({
    type: "Feature",
    geometry: {
      type: "Point",
      coordinates: [post.data.coordinates[1], post.data.coordinates[0]],
    },
    properties: {
      title: post.data.title,
      slug: post.slug,
      description: post.data.description,
    },
  }));

const geojson = {
  type: "FeatureCollection",
  features: geotaggedPosts,
};

// Get the token from astro.site
const MAPBOX_TOKEN = Astro.site
  ? process.env.PUBLIC_MAPBOX_TOKEN
  : import.meta.env.PUBLIC_MAPBOX_TOKEN;

// Debug log
console.log("Map page token status:", {
  hasToken: !!MAPBOX_TOKEN,
  siteExists: !!Astro.site,
  envKeys: Object.keys(process.env),
});
---

<script>
  // Log client-side environment variables
  console.log("Client-side env check:", {
    hasToken: !!import.meta.env.PUBLIC_MAPBOX_TOKEN,
    envKeys: Object.keys(import.meta.env),
  });
</script>

<Layout title="Post Map">
  <Header activeNav="map" />
  <main>
    <h1 class="text-2xl font-semibold mb-6">Posts Around the World</h1>
    <div class="w-full h-[600px] rounded-lg overflow-hidden shadow-lg">
      <MapView
        client:only="react"
        geojson={geojson}
        mapboxToken={MAPBOX_TOKEN}
      />
    </div>
  </main>
  <Footer />
</Layout>

<style>
  main {
    @apply mx-auto w-full max-w-3xl px-4 pb-12;
  }
</style>
